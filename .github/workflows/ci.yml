name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  JAVA_VERSION: '17'

jobs:
  # =============================================
  # ðŸ§ª CODE QUALITY & TESTING
  # =============================================
  code-quality:
    name: ðŸ“Š Code Quality & Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ”§ Install Dependencies
      run: |
        npm ci
        npm run pods:install || echo "CocoaPods not needed for CI"
        
    - name: ðŸ·ï¸ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-deps-
          
    - name: ðŸ“ TypeScript Check
      run: npm run type-check
      
    - name: ðŸ” ESLint
      run: npm run lint
      
    - name: ðŸ’… Prettier Check
      run: npm run format:check
      
    - name: ðŸ§ª Run Tests
      run: npm run test:ci
      env:
        CI: true
        
    - name: ðŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # =============================================
  # ðŸ”’ SECURITY AUDIT
  # =============================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ” Security Audit
      run: npm audit --audit-level=moderate
      
    - name: ðŸ“Š Dependency Check
      run: |
        npx depcheck --ignores="@types/*,eslint-*,prettier,jest,@testing-library/*"
        
    - name: ðŸ›¡ï¸ License Check
      run: npx license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD'

  # =============================================
  # ðŸ“± ANDROID BUILD
  # =============================================
  android-build:
    name: ðŸ¤– Android Build
    runs-on: ubuntu-latest
    needs: [code-quality, security]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: ðŸ“² Install Dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Generate Debug APK
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon
        
    - name: ðŸ“¦ Upload APK Artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7

  # =============================================
  # ðŸŽ iOS BUILD (macOS only)
  # =============================================
  ios-build:
    name: ðŸŽ iOS Build
    runs-on: macos-latest
    needs: [code-quality, security]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ’Ž Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        working-directory: ios
        
    - name: ðŸ“² Install Dependencies
      run: npm ci
      
    - name: ðŸ¥¥ Install CocoaPods
      run: |
        cd ios
        pod install --repo-update
        
    - name: ðŸ—ï¸ Build iOS
      run: |
        cd ios
        xcodebuild -workspace ReactNativeSkeleton.xcworkspace \
          -scheme ReactNativeSkeleton \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 14' \
          build

  # =============================================
  # ðŸ“Š PERFORMANCE ANALYSIS
  # =============================================
  performance:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“² Install Dependencies
      run: npm ci
      
    - name: ðŸ“Š Bundle Size Analysis
      run: |
        npm run build:analyze || echo "Bundle analysis not configured yet"
        
    - name: ðŸ” Performance Audit
      run: |
        npx bundlesize || echo "Bundlesize not configured yet"

  # =============================================
  # ðŸ“‹ BUILD SUMMARY
  # =============================================
  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [android-build, ios-build, performance]
    if: always()
    
    steps:
    - name: ðŸ“Š Build Status Summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Android Build | ${{ needs.android-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| iOS Build | ${{ needs.ios-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance | ${{ needs.performance.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY 